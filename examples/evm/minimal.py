from seth import ManticoreEVM
################ Script #######################

seth = ManticoreEVM()
seth.verbosity(0)
#And now make the contract account to analyze
# cat  | solc --bin 
source_code = '''
pragma solidity ^0.4.13;
contract NoDistpatcher {
    event Log(string);
    function() payable {
        if (msg.data[0] == 'A') {
            Log("Got an A");
        }
        else{
            Log("Got something else");
        }
    } 
}
'''

print "[+] Creating a user account"
user_account = seth.create_account(balance=1000)


print "[+] Creating a contract account"
bytecode = '6060604052361561004b5760e060020a600035046319e44e3281146100895780631d972d4114610092578063b00606a5146100ad578063ba3ae0ce146100e5578063da95ebf71461011f575b6101dc600160a060020a0333166060908152346080527fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c90604090a1565b6101de60005481565b6101de60043560016020526000908152604090205460ff1681565b6101de6004356024356044356064356000848152600260205260408120805482908190600160a060020a031681141561036457610002565b6101f060043560026020819052600091825260409091208054600182015492820154600390920154600160a060020a039182169392911684565b6101de6004356024356000805460019081018083556000194301401860608181526c01000000000000000000000000600160a060020a0387169081026080908152609487905260548320808752600260208190526040909720805473ffffffffffffffffffffffffffffffffffffffff19168a17815595860188905595850184905590815260a086905260c08590529192917fd0df5d45cd50ae0aaff9013e6b3dbffdd1d9722cd6a2ecee1589e7bf64cf837591a1505092915050565b005b60408051918252519081900360200190f35b6060938452608092835260a09190915260c05290f35b8260000160009054906101000a9004600160a060020a0316600160a060020a031660008460010160005054604051809050600060405180830381858888f1935050505090508015610355577f94d3c694ab2f443abe65d90aba86027f8c9ba2f44f1073bb89390c7ca0bf866a8360000160009054906101000a9004600160a060020a031684600101600050548560030160009054906101000a9004600160a060020a0316856040518085600160a060020a0316815260200184815260200183600160a060020a0316815260200182600160a060020a0316815260200194505050505060405180910390a16002600050600089815260200190815260200160002060006000820160006101000a815490600160a060020a030219169055600182016000506000905560028201600050600090556003820160006101000a815490600160a060020a03021916905550505b8093505b505050949350505050565b606088815260ff8816608090815260a088905260c087905260019160e091602091908186866161da5a03f11561000257506040805151600160a060020a038116845260209290925282205490925060ff1615156103c057610002565b8260030160009054906101000a9004600160a060020a0316600160a060020a03166000141561048557818360030160006101000a815481600160a060020a03021916908302179055507fa0cf8a24caec31ed7663626cd6d6ad687b5b0004a7a743af24aabc3665ae24d28360000160009054906101000a9004600160a060020a03168460010160005054846040518084600160a060020a0316815260200183815260200182600160a060020a03168152602001935050505060405180910390a1610359565b81600160a060020a03168360030160009054906101000a9004600160a060020a0316600160a060020a031614156102065761000256'.decode('hex')

#Initialize contract
# Note that the initialization argument would have been passed immediatelly 
# after the init bytecode  init=bytecode+pack(parameter)
contract_account = seth.create_contract(owner=user_account,
                                        init=bytecode)

contract_account = seth.get_world().create_account( None, 100000, code=bytecode, storage=None)
   
print "[+] Now the symbolic values"

symbolic_data = seth.SByte(320) 
symbolic_value = None 
seth.transaction(caller=user_account,
                address=contract_account,
                data=symbolic_data,
                value=symbolic_value )

print "[+] There are %d reverted states now"% len(seth.final_state_ids)

print "[+] There are %d alive states now"% len(seth.running_state_ids)
for state_id in seth.running_state_ids:
    seth.report(state_id)

print "[+] Global coverage:"
print seth.coverage(contract_account)



