name: MacOS Tests

on:
  schedule:
    # Run every day at 11 PM.
    - cron:  '0 23 * * *'

jobs:
  tests:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        type: ["ethereum_truffle", "ethereum_bench", "ethereum", "ethereum_vm", "wasm", "wasm_sym", "other"]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    - name: Install NPM
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    - name: Cache uv packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-
    - name: Install dependencies
      env:
        TEST_TYPE: ${{ matrix.type }}
      run: |
        # Install uv for faster package management
        curl -LsSf https://astral.sh/uv/install.sh | sh
        source $HOME/.cargo/env
        EXTRAS="dev-noks"
        uv pip install --system -e .[$EXTRAS]
    - name: Install Mac Dependencies
      run: |
        source $HOME/.cargo/env
        brew install bash
        brew install wabt
        brew install SRI-CSL/sri-csl/yices2
        brew tap cvc4/cvc4
        brew install cvc4/cvc4/cvc4
        uv pip install --system solc-select
        solc-select install 0.4.24
        solc-select install 0.5.11
        solc-select use 0.4.24
    - name: Run Tests
      env:
        TEST_TYPE: ${{ matrix.type }}
      run: |
        cp scripts/run_tests.sh .
        ./run_tests.sh
